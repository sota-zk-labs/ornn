module cpu_addr::cpu_constraint_poly {

    use std::vector;
    use std::vector::{push_back, borrow, borrow_mut};
    use lib_addr::prime_field_element_0::{fmul, fpow};


    const EPRODUCT_INVERSE_ZERO: u64 = 0x0001;

    const PRIME: u256 = 0x800000000000011000000000000000000000000000000000000000000000001;

    {% include "move/memory-map.move.template" %}
    public fun fallback(ctx: &vector<u256>): u256 {
        let ctx = *ctx;
        let res = 0;

        let remain = 404 - vector::length(&ctx);

        for (i in 0..remain) {
            push_back(&mut ctx, 0);
        };

        {% include "move/load-memory.move.template" %}
        let point = oods_point;

        {
            // compute expmods
            {{ expmods }}
        };

        {
            // compute domains
            {{ domains }}

        };

        {
            // compute denominators
            {{ denominators }}
        };

            {
                // compute denominator_invs

                // Start by computing the cumulative product.
                // Let (d_0, d_1, d_2, ..., d_{n-1}) be the values in denominators. After this loop
                // denominatorInvs will be (1, d_0, d_0 * d_1, ...) and prod will contain the value of
                // d_0 * ... * d_{n-1}.
                // Compute the offset between the partialProducts array and the input values array.
                let productsToValuesOffset = 18;
                let prod = 1u256;
                let partialProductEndPtr = 380;
                let partialProductPtr = 362;
                while (partialProductPtr < partialProductEndPtr) {
                    partialProductPtr = partialProductPtr + 1;
                    *vector::borrow_mut(&mut ctx, partialProductPtr) = prod;
                    // prod *= d_{i}.
                    prod = fmul(prod, *borrow(&ctx, partialProductPtr + productsToValuesOffset));
                };

                let firstPartialProductPtr = 362;
                // Compute the inverse of the product.
                let prodInv = fpow(prod, PRIME - 2);

                assert!(prodInv != 0, EPRODUCT_INVERSE_ZERO);

                let currentPartialProductPtr = 380;

                // Compute the inverses.
                // Loop over denominator_invs in reverse order.
                // currentPartialProductPtr is initialized to one past the end.
                while (currentPartialProductPtr > firstPartialProductPtr) {
                    currentPartialProductPtr = currentPartialProductPtr - 1;
                    // Store 1/d_{i} = (d_0 * ... * d_{i-1}) * 1/(d_0 * ... * d_{i}).
                    *borrow_mut(&mut ctx, currentPartialProductPtr) = fmul(*borrow(&ctx, currentPartialProductPtr), prodInv);
                    // Update prodInv to be 1/(d_0 * ... * d_{i-1}) by multiplying by d_i.
                    prodInv = fmul(prodInv, *borrow(&ctx, currentPartialProductPtr + productsToValuesOffset));
                };

            };

        {% include "move/load-memory.move.template" %}

        {
            {{ instructions }}

            // compute compositions

            let composition_alpha_pow = 1u256;
            let composition_alpha = /*composition_alpha*/ *borrow(&ctx, 41);

            {{ compositions }}
        };
        res
    }


    #[test_only]
    use aptos_std::debug;

    #[test]
        fun test_fallback() {
            let ctx: vector<u256> = vector[
                3197217402377420549807301481158349892858971871383958510776677383324152463094,
                2253879008760025657453121132867989323563526513843283036322009523071045420572,
                2310412858702653362915880132536764937085309291628714610535637671570908301621,
                126657135114259205810665710096094000119312649163758177838032753629533589712,
                3585153049555662050453331834571057439379833908772600683912362019117580275051,
                1900411239845897696228062510898864380999791093864132646112988887271406490608,
                3436211370341291831757572430396366066456882724956853684419537539619589314461,
                67108864,
                65536,
                32768,
                731,
                1,
                2266515,
                5,
                3232402799020273123701672899620163879959024531795856118904701543579107478288,
                438963245466416667030274468984203196494549069586215159473149318689786606805,
                237091730132628179595235854248170298673273730422057097434751404289728973511,
                2357368800805230664654205636909556797949827786540246625647507229095350308130,
                1,
                0,
                65535,
                2057101974348072098895286686097740874644021284243895364547569106336505195612,
                1,
                0,
                103819182728899869565882727309406307775952474882936402905235507144116663626,
                829863683768294307140114148203146716537258780650685506485473402189848958363,
                3270498057890308734753746647964206995416464406782194412141429358700681652838,
                2089986280348253421170679821480865132823066470938446095505822317253594081284,
                1713931329540660377023406109199410414810705867260802078187082345529207694986,
                2275839,
                2374143,
                2898431,
                5519871,
                1740032260176861730069282301706899931803609121779848595553493302998775290819,
                1955765603506422831269466731145883520413367464641297033809395717401241253218,
                3232402799020273123701672899620163879959024531795856118904701543579107478288,
                438963245466416667030274468984203196494549069586215159473149318689786606805,
                2357368800805230664654205636909556797949827786540246625647507229095350308130,
                2057101974348072098895286686097740874644021284243895364547569106336505195612,
                103819182728899869565882727309406307775952474882936402905235507144116663626,
                829863683768294307140114148203146716537258780650685506485473402189848958363,
                3334892972819470717353039876663887397028904306209984841245893150173491288,
                3548947510507586517675900568239060198226108205794571959894920328866856445573,
                712427633099186256597047841283370005520810437757362091195695622900735252569,
                2029649921833934921784626980805058858076500080714603032361181641534946701867,
                160555420258854248089873048749694648598400411684329932268041614982221387666,
                223527843589458402271174547521155257728975697045588134434496836581764527900,
                814940761437210685471668812440764745370613916570816610913208530164415043493,
                1993290625982870565372910987309909097344508658728739320510722835781774169273,
                2272147017812579606347180553081347576119538165411450980680288020507267462901,
                211139281063722280838328049680277733523493347251951347839538190670624209095,
                3444651648461867043858455623706248487274940089497255388317645657091938967647,
                87129861544957347793038446981198088048655915251532716161733530893163993171,
                664232891671426511901835086752872209002947785119558773051770994448651539220,
                326362128304758465073016159714982312842881567873333789162469070374876828580,
                2441904163698353036460352145221944831848470628538118758495716186977383881751,
                2681380276974810150866768597111301499173409974540739657092214906566435166243,
                2501718132621277256046203544042695455023326484987057801940426714923833643620,
                17696682845535337224570325747887485927381007680513814900187347175742637380,
                1838709828518648883521242106686653884204839827924527955895312237462803150938,
                2382094083916273823869432778086786693952806493654763628775100189043106532137,
                1596672803944313529923426304757581291633326723383150553887983837117672248799,
                787024873543905010025819948572150004486020584933289785162320523370109986629,
                1115069916731685144330688748322545059445387488612736488895270111051073591159,
                3295548627554471911525566542782083975717390705012405626122291097413020145851,
                1044252291803837767115471168300286725035496483820492609975206329687026399827,
                705453234213411887034200109493350047607992234703130841732281674399378177645,
                1531070214898993178570339706939895482098662495362453444175047921069262454378,
                3029320690401909606174723023464519687193895376403331172496560875069197640287,
                3216783136314992621596507560725163780054364082257822626149235666091281860524,
                1285816602797393089922112759086798665553256735844994493092403633623663753695,
                565864424862514084442660391069731686938893218508932377401418685197507267652,
                837972989780537566386904452249311037063642478871035512711190441399228634558,
                158676038194185278001594288640310640432703522799672161544737468718014704300,
                2661352563210185743148393218096461976504321451299937014444567780537084865395,
                273196362064076793984876358839454613098639675536736095488614814502268636041,
                2157555245004112834716159616200076252030703902099681571279488180500286243034,
                2303243855634721574579672732226436541048746989312377914462570800546327285010,
                2849766913738765272324647937846941303746142327044885763230110302544975841377,
                501760108747994476062646534621438823950520003998410297763295832244602254004,
                132761094188370146666991734017175241152622330372694929658177674577146938837,
                3405752159210470593219570921096773605700808403979093898820990617286575274527,
                238353794166812802458343182838358907018390454172928663435521389720674510104,
                497429770447516113100430303580445744971387802775040962777513418301569202174,
                308272361007210190630136338338633856093371179725166786784556586721205599980,
                3361290998515397140351446816022356738649271298482542466604092394467283149413,
                552645066139080647252095892262343742776058820265553294004791139603457233862,
                3562522345136070306047082255579360508831583202350984569643332989051200279698,
                708873269884547149891534309366008267180444961692643734434085484031214616168,
                2855995613834990655154798125514326958500109948634629223094964290009965592903,
                3400670554467412434357015053934507139522518035561944396303796946350761166028,
                652530355806014330701310733437750058655004738290871636448963301364405750673,
                1005620991030225487476906776541635101031047893045990615716134366908704784785,
                3067931102052040793959375250507492914834703343095615798610189942398936963913,
                1366928844352318053837943451152298450000262682293794125255951293869693797364,
                3243191164140085924556648433809931503810013174218229126528149238085533749322,
                2347069970609071138902453601741794739944720004429235728003209212921536050006,
                1541025629837553497702037789163031511392569432705502753624743166413078698680,
                3485103300321495519229545878245328664002060022626169515119662475140726229266,
                2711975106671396967165344511584824910706702449175010712143310732286411571942,
                2068919339923520396966846487911385773613667020847213981899497860323964780617,
                1083354048358815964548425653066764853811691069478618025835795844984945769435,
                1124864435660620675406873398665194722406967512884428495888619128963454800240,
                2868087554638908323154006244825879340940952601340503073323761313294404574849,
                2342678015735582754697771933889942868355265597719664477105777986287204754022,
                3474483632228758181937486801249112057343145736998740311782034115529751794757,
                31201692442061647039716910679411954365320304605239472546780182039189945692,
                1212840480246206696235770909654684807995618705861373671551293455584138331829,
                1898464141551994368036004892485324330704719266229696305699458067756270134417,
                657487080482464123041777966620784237783056907835081551669814010772229565628,
                2985242906942949007305331158222461006101781404214658938414372693858150475058,
                2819515060999088611162432179430520888258375146299073462713120822295090399321,
                2950784660646704495333396141720907011629421796865153858929342304736509400158,
                2302835862943186314228723778278426911530993505895764052172100659650380480278,
                926690961112950472956447522388202939905997847053526299632076337151118715416,
                34373083556969879777456879556753368970979166779552946546540214004729037825,
                2002719898484053562336671466809556625109609097929618698273227612196748439587,
                1840519106802627693427391424881131056515476324199296541642993500541426913397,
                3463042798780391435325495679887312579514133973159365906066977990831758306607,
                1459572508849044237841124867719491584099765684483213705577940992200066898602,
                3526901276518843093090567381168332599590025023496589650509817726916659004501,
                970011309380434567781242208249627446852582740387127887650755858968321419188,
                1617512889855765841473677708779964707501382785379813378119060985433543878387,
                2557019374503580175311963327376668824519650579047032349119499978139436150247,
                46856359499492385952986417299785986741351684297588203068424205442933284583,
                1396722419965945535392800692584031409876195255542377178347088516948459643128,
                2130712495667970637270824792250864708407165912130379654007189433211755466209,
                915046473634192115030950277622446733045663172270182246762679931459553365015,
                147626856306593467134093601725457010181525246088471867247598980938405301915,
                847257011535103065167163722165706338495374813012743849020770627484535545331,
                1686825470597288950215896636746830197633755989415330648253910715740307248531,
                783620294062261459910427888244425506194750089533308638754725582709409746618,
                2528825238541814192807374103076921939772030565844763430927162319143277329052,
                2918745970952349225981563115885027825637722544554825359210159293205472016447,
                3018503161046998656327886570483651035999513720673499136455794622618199577026,
                2736151855557415351434256703143136706620497820314547810375775399527769918735,
                3470660422431183249015648540601754662936754964800977221372013128809655202277,
                2906239157190553063763537124530272555589091814437233211368589200812218450182,
                1502211803160940966478584201516892778664209796418783967981781651783002425988,
                813348725118567341926270913370268807221422478290745517629846627074543660898,
                219274034390323733709277493310058217195352716537557257367798018983640306456,
                1464161924454163335713919495314079757766789426167725204608821622554184687946,
                655507783248751148991081054048600887545202889309484743566590723437711233122,
                2430061940428814172953430777160569473181453532210165529789849009034477250840,
                3493003465176367910044057472223792371162131945253252182670909140270678147268,
                2973105169848528321641465044286480990753720528677186828258616391529394495389,
                853188831200091507013438796760615135941739399626146807955862246099843524978,
                1589594603423788188917486815731669793500158238778197897697887574906312765047,
                1068050092341779183894331547665262540515110864267904346370087550417074730816,
                2128751411674014359863099700016634162370006201660696718760913935015289336158,
                384935837206753318830463791865575679046140119820669433756848289429604384692,
                726570947810898029073689261366662576734138282309572087682823380577444799574,
                3261226432113843892097970428776909332487970694816584189703410878906039187627,
                2199967878346940806272973109580737755706323899816699122974955313035122307001,
                124965664923479667916341650758838076066521835114474297701300463914054338794,
                1340206160429593290175828288741727352235682214798840607479286152551208617571,
                1798374238499158581089361409202818993444670951454226091296573047370524079333,
                421650568764506837788929473562633181394557130692144724498497904999685210339,
                2156746992266944830923682319883717226602377362662078524693492594911278576092,
                960573838276918475819967424344163848118571285784954911430561433304486215997,
                2030488069828876147834787029893849202751237234936148681728752305094239794813,
                13945806494149454568860357508751917124255380163307690158420641446674861483,
                158221745741736583481292000326631212195947748141973753377107392215799674893,
                760649456072976804480389360226505244639823326578392060624440749361134269223,
                1244298301514977119415351963833848548672097338446643076926597264877177655472,
                1983125121141353075338617034220201465511088558493860913660254694684591293924,
                3433058322556997385808326427813866018635459529882716341969670911542846840643,
                2293616198249979611069302091009206703997133870296215063542153845343129162792,
                2979495737227865788684520645322098297212125062796289269874390219133768106590,
                2140797709697576205199434180840349046716558172944923299190420328303214325118,
                1851741961550619300002960626894738067478001474944185903250687964383742617354,
                2740114491412907767283267258442306685847732613760644464759977549849853456628,
                2754305301900734920986875948591072228538417853269302910280476072703057843210,
                3583499118688568867547567711198248902784617926020114792133080935522162962620,
                879088762041316272903276884696391426573773145887622157886407231456710882706,
                299942595713014973125270746155169585038203084564211560736137343065738512595,
                165740224907666484184165788524923491720258267007155555806278818566115109135,
                1062971607155957327538963172874878060177387676926472086184811835209411140733,
                1661520415101280729838792053222900019793779692950482354181969847988636612785,
                626752279474411338732550399492446514134676045334113892280675119296335458741,
                1914507326026450874779039863357614639814115937793290577417121529270341260744,
                987571013202154973546550036645064438099083417826355490737121739032610262962,
                3472093544034254813838586212151141413014714000283617761947975784985027077773,
                1437731377581722799463248300808692713621768562751691635893471932719743841905,
                2380727941980047749376255611080021911457181554423995910962638198968309775327,
                2459686040895053851619188830276783484129744555924178203258627207075981351729,
                1332827597626204962024573756749133242513179457254936548626088601166894992240,
                773359759136053650597437225702989413120609486073645920672108941830553746406,
                2484080095441419615538308637595856104262898872138472637717781970142680197752,
                3194083049803751608385391901944495860779870146289210021530966133327101038179,
                990743446496718147467697361294276118796959529836559289624697367411008631077,
                2780903918919813181591877406952730301905704956676136226710904127127599815322,
                620474515902095668865943764551107769238288746131540583481741076648585447125,
                1121530778520052553749251062335945117881316502960114601272346797197790421943,
                901178635501879554434872566229218741289984791525580283181733804266312813700,
                697391553371173863612550837240975344486488087320374970390037710298455477450,
                2732307669188945325854114737389183042776536788824793713083886974792219744825,
                2338628250610829325669301343722609515984329057819038032426812465160222807290,
                1429140985201337381712728749775448040490918734845987139226695593114441573328,
                2860060702814074443660565773475913617234905426744329206115136383804386020203,
                483761982439919894593388324202635209682397085661100709298092604086067195689,
                3113468192755088194475224473019300595084072203063888222429649604149846025470,
                1077237170346378479795457115355809389727744650233565858480133501275088050662,
                2683497072801868375153287445648142781364035758349044840956609769445678442383,
                527483451218087147407715216140631811828341128654551875110825221318920104903,
                1537989283075453157533482844764000181696146779535383168322256458047971836078,
                27936153261266018801330581262564421469987165709417602493291468898528910365,
                3278370496702299748674269236276661667852606967584853254966229280508098255632,
                226539669921314036857477019419899705041368189885143891208790040279718766785,
                1269511949921446270848196740903796241152745874572591626633347824746107129459,
                2741219968241427520279634590872536162959212579693297461284641477437622950727,
                3348586724986155054541592424092249779115716097100649887613403667075885421595,
                3317459154804030694905016290382297989943643905616618784628793304843764356620,
                249580235095900926615027717784383999922955983492659811672291564149726388275,
                928341035809801979316176889920034751866243941699253344561869896690986171637,
                2888812570833472291390949249128741821436320961302192051463465109572910631803,
                1466646577263945838484048654299189047507271456871685225813565340698949066048,
                1465300258149816604277918231169105856210290953684520748742892771474398387887,
                2260757620146831758778715572294855187364447009334995256514971407581410380432,
                223025586369753385457385233015607294673592519423150561323025051013835831691,
                1160668707298726209394818609124852354377254156290464939706007183173515754674,
                1913035609632647259670559371462489875703230935143759876685426779813670146701,
                2823544174680341776302925909127028983985215137140561157167066308765272561056,
                2692886551010028841752933091884592069989881181623557755492431518826525645197,
                1185072949316073117873709937271588433975419892166069499005792857528489590476,
                1865326701797580211402422109276905438067881238227113708412457704289085166238,
                3450414845209671749805014579205318673554387752313497838860328093680389622609,
                2457543442938337013542413450972978791539180091531413851905977846232996021993,
                1861725585888135483002525476594161578735500150375327798504349048494360186762,
                1957220960100107711477854975523598424361803880361037445720526835303658634738,
                3399568337988807213951242524668118338825478388222090656781935919416776791060,
                692223117400285147740375257026254459594884842532003256636493640218447068094,
                1775505314517370329558999185057719044151070126138922957483837039931931456262,
                1326389350710615116391365680256163199973980758823363951013032037682388997786,
            ];
            debug::print(&fallback(&ctx));
        }
}
